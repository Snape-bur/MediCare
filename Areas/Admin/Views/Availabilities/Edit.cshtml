@model MediCare.Models.Doctor
@using MediCare.Models
@{
    ViewData["Title"] = "Edit Availability";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    var allDays = Enum.GetValues(typeof(DayOfWeek)).Cast<DayOfWeek>().ToList();
}

<div class="max-w-4xl mx-auto">
    <div class="mb-10 flex items-center justify-between">
        <div>
            <h2 class="text-3xl font-black text-slate-900 tracking-tight">Modify <span class="text-blue-600">Schedules</span></h2>
            <p class="text-slate-500 font-medium">Updating availability for Dr. @Model.AppUser?.FullName</p>
        </div>
        <a asp-action="Index" class="text-xs font-black text-slate-400 uppercase tracking-widest hover:text-blue-600 transition-colors">Back to Overview</a>
    </div>

    @if (TempData["Message"] != null)
    {
        <div class="bg-green-600 text-white px-6 py-4 rounded-2xl mb-8 flex items-center gap-3 shadow-lg shadow-green-100">
            <i data-lucide="check-circle" class="w-5 h-5"></i>
            <span class="font-bold text-sm">@TempData["Message"]</span>
        </div>
    }

    <form asp-action="Edit" method="post" class="space-y-6">
        <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-xl shadow-slate-900/5 p-10">
            <div class="flex items-center justify-between mb-10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600">
                        <i data-lucide="clock" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-lg font-black text-slate-900 uppercase tracking-wider">Time Slots</h3>
                </div>
                <button type="button" id="addSlot" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 text-[10px] font-black uppercase rounded-lg hover:bg-blue-600 hover:text-white transition-all">
                    <i data-lucide="plus" class="w-4 h-4"></i> Add New Slot
                </button>
            </div>

            <div id="availabilityContainer" class="space-y-4">
                @for (int i = 0; i < Model.Availabilities.Count; i++)
                {
                    var slot = Model.Availabilities.ElementAt(i);
                    <div class="availability-row group flex flex-col md:flex-row items-center gap-4 bg-slate-50 rounded-2xl p-4 border border-transparent transition-all">
                        <input type="hidden" name="availabilities[@i].AvailabilityId" value="@slot.AvailabilityId" />

                        <div class="w-full md:w-1/3">
                            <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block ml-1">Day of Week</label>
                            <select name="availabilities[@i].Day" class="day-select w-full bg-white border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-600 font-bold text-slate-900 py-2.5">
                                @foreach (var day in allDays)
                                {
                                    <option value="@((int)day)" selected="@(slot.Day == day)">@day</option>
                                }
                            </select>
                        </div>

                        <div class="w-full md:w-1/4">
                            <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block ml-1">Start Time</label>
                            <input type="time" name="availabilities[@i].StartTime" value="@slot.StartTime.ToString(@"hh\:mm")"
                                   class="start-time w-full bg-white border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-600 font-bold text-slate-900 py-2.5" />
                        </div>

                        <div class="hidden md:block mt-4 text-slate-300">
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </div>

                        <div class="w-full md:w-1/4">
                            <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block ml-1">End Time</label>
                            <input type="time" name="availabilities[@i].EndTime" value="@slot.EndTime.ToString(@"hh\:mm")"
                                   class="end-time w-full bg-white border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-600 font-bold text-slate-900 py-2.5" />
                        </div>

                        <button type="button" class="remove-slot mt-4 md:mt-4 p-2.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all">
                            <i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i>
                        </button>
                    </div>
                }
            </div>

            <div id="validationMessage" class="mt-8 space-y-2"></div>
        </div>

        <div class="flex items-center justify-between gap-4 pt-6 pb-20">
            <a asp-controller="Dashboard" asp-action="Index" class="px-10 py-5 bg-white text-slate-400 font-black rounded-[2rem] border border-slate-200 hover:text-slate-900 transition-all">
                Discard
            </a>
            <button id="saveBtn" type="submit" class="flex-1 py-5 bg-blue-600 text-white font-black rounded-[2rem] shadow-xl shadow-blue-200 hover:bg-blue-700 hover:-translate-y-1 transition-all">
                Save Schedule Changes
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        const dayNames = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

        document.getElementById('addSlot').addEventListener('click', function () {
            const container = document.getElementById('availabilityContainer');
            const index = container.querySelectorAll('.availability-row').length;
            const newRow = document.createElement('div');
            newRow.className = "availability-row group animate-in zoom-in-95 duration-200 flex flex-col md:flex-row items-center gap-4 bg-slate-50 rounded-2xl p-4 border border-transparent transition-all";

            newRow.innerHTML = `
                <div class="w-full md:w-1/3">
                    <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block ml-1">Day of Week</label>
                    <select name="availabilities[${index}].Day" class="day-select w-full bg-white border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-600 font-bold text-slate-900 py-2.5">
                        ${dayNames.map((name, i) => `<option value="${i}">${name}</option>`).join("")}
                    </select>
                </div>
                <div class="w-full md:w-1/4">
                    <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block ml-1">Start Time</label>
                    <input type="time" name="availabilities[${index}].StartTime" class="start-time w-full bg-white border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-600 font-bold text-slate-900 py-2.5" />
                </div>
                <div class="hidden md:block mt-4 text-slate-300"><i data-lucide="arrow-right" class="w-4 h-4"></i></div>
                <div class="w-full md:w-1/4">
                    <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block ml-1">End Time</label>
                    <input type="time" name="availabilities[${index}].EndTime" class="end-time w-full bg-white border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-600 font-bold text-slate-900 py-2.5" />
                </div>
                <button type="button" class="remove-slot mt-4 md:mt-4 p-2.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                </button>
            `;
            container.appendChild(newRow);
            lucide.createIcons(); // Re-init icons for the new row
        });

        document.addEventListener('click', function (e) {
            if (e.target.closest('.remove-slot')) {
                e.target.closest('.availability-row').classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    e.target.closest('.availability-row').remove();
                    checkForDuplicates();
                }, 200);
            }
        });

        function checkForDuplicates() {
            const rows = document.querySelectorAll('.availability-row');
            const slots = [];
            const messages = [];
            const saveBtn = document.querySelector('#saveBtn');

            rows.forEach(row => {
                const day = row.querySelector('.day-select')?.value;
                const start = row.querySelector('.start-time')?.value;
                const end = row.querySelector('.end-time')?.value;
                row.classList.remove('bg-red-50', 'border-red-200');

                if (day && start && end) {
                    const startTime = new Date(`1970-01-01T${start}`);
                    const endTime = new Date(`1970-01-01T${end}`);

                    if (startTime >= endTime) {
                        messages.push(`🕒 The shift on ${dayNames[day]} has an invalid range (Start must be before End).`);
                        row.classList.add('bg-red-50', 'border-red-200');
                    }

                    const conflict = slots.find(s =>
                        s.day === day &&
                        ((startTime >= s.startTime && startTime < s.endTime) ||
                         (endTime > s.startTime && endTime <= s.endTime) ||
                         (startTime <= s.startTime && endTime >= s.endTime))
                    );

                    if (conflict) {
                        messages.push(`⚠️ Time overlap detected on ${dayNames[day]} between ${start} and ${end}.`);
                        row.classList.add('bg-red-50', 'border-red-200');
                    } else {
                        slots.push({ day, startTime, endTime });
                    }
                }
            });

            const msgBox = document.querySelector('#validationMessage');
            msgBox.innerHTML = messages.map(m => `<div class="p-4 bg-red-50 text-red-600 rounded-xl text-xs font-bold flex items-center gap-2 animate-in fade-in slide-in-from-left-2"><i data-lucide="info" class="w-4 h-4"></i>${m}</div>`).join("");

            if (messages.length > 0) {
                saveBtn.disabled = true;
                saveBtn.classList.add("opacity-50", "cursor-not-allowed", "grayscale");
            } else {
                saveBtn.disabled = false;
                saveBtn.classList.remove("opacity-50", "cursor-not-allowed", "grayscale");
            }
            lucide.createIcons();
        }

        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('day-select') || e.target.classList.contains('start-time') || e.target.classList.contains('end-time')) {
                checkForDuplicates();
            }
        });

        document.addEventListener('DOMContentLoaded', checkForDuplicates);
    </script>
}